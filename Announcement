import React, { useState } from 'react';
import { Alert, View, Text, TextInput, Button, FlatList, StyleSheet, TouchableOpacity } from 'react-native';

interface Comment {
  id: number;
  content: string;
}
interface Announcement {
  id: number;
  title: string;
  comments: Comment[];
}

export default function App() {
  const [loggedIn, setLoggedIn] = useState(false);
  const [userRole, setUserRole] = useState<'admin' | 'user' | null>(null);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [announcements, setAnnouncements] = useState<Announcement[]>([
    { id: 1, title: 'Welcome to issue an announcement', comments: [] }
  ]);
  const [newTitle, setNewTitle] = useState('');
  const [contentPage, setContentPage] = useState(true);
  const [selectedAnnouncementId, setSelectedAnnouncementId] = useState<number | null>(null);
  const [newComment, setNewComment] = useState('');

  const handleLogin = () => {
    if (username === 'Ryan' && password === '1234') {
      setLoggedIn(true);
      setUserRole('admin');
      setContentPage(true);
    } else if (username === 'user' && password === 'qwer') {
      setLoggedIn(true);
      setUserRole('user');
      setContentPage(true);
    } else {
      Alert.alert('Login failed', 'Incorrect username or password. Please try again!');
    }
  };

  const handleAddAnnouncement = () => {
    if (newTitle.trim() === '') {
      Alert.alert('Content cannot be empty.', 'Please enter the announcement content before publishing.');
      return;
    }
    const newAnnouncement: Announcement = {
      id: Date.now(),
      title: newTitle,
      comments: []
    };
    setAnnouncements([...announcements, newAnnouncement]);
    setNewTitle('');
  };

  const handleDeleteAnnouncement = (id: number) => {
    const remaining = announcements.filter(item => item.id !== id);
    setAnnouncements(remaining);
  };

  const handleAddComment = () => {
    if (newComment.trim() === '') {
      Alert.alert('Content cannot be empty.', 'Please enter your comment before submitting.');
      return;
    }
    if (selectedAnnouncementId === null) return;
    const newCommentObj: Comment = { id: Date.now(), content: newComment };
    setAnnouncements(prev => prev.map(ann => {
      if (ann.id === selectedAnnouncementId) {
        return { ...ann, comments: [...ann.comments, newCommentObj] };
      }
      return ann;
    }));
    setNewComment('');
  };

  if (!loggedIn) {
    return (
      <View style={styles.container}>
        <Text style={styles.heading}>Login</Text>
        <TextInput
          style={styles.input}
          placeholder="username"
          value={username}
          onChangeText={setUsername}
        />
        <TextInput
          style={styles.input}
          placeholder="password"
          value={password}
          secureTextEntry={true}
          onChangeText={setPassword}
        />
        <Button title="Login" onPress={handleLogin} />
      </View>
    );
  }

  if (loggedIn && contentPage) {
  return (
    <View style={styles.container}>
      <Text style={styles.heading}>Content</Text>

      <View style={styles.centeredContent}>
        <TouchableOpacity onPress={() => setContentPage(false)} style={styles.squareBox}>
        </TouchableOpacity>
        <Text style={styles.squareText}>Announcement{'\n'}System</Text>
      </View>

      <View style={styles.bottomButtons}>
        <View style={styles.buttonWrapper}>
          <Button
            title="Logout"
            onPress={() => {
              setLoggedIn(false);
              setUserRole(null);
              setUsername('');
              setPassword('');
              setContentPage(true);
              setSelectedAnnouncementId(null);
            }}
          />
        </View>
      </View>
    </View>
  );
}

  if (loggedIn && !contentPage && selectedAnnouncementId === null) {
    return (
      <View style={styles.container}>
        <Text style={styles.heading}>Announcement List</Text>
        <FlatList
          data={announcements}
          keyExtractor={item => item.id.toString()}
          renderItem={({ item }) => (
            <TouchableOpacity onPress={() => setSelectedAnnouncementId(item.id)}>
              <View style={styles.itemContainer}>
                <Text style={styles.itemText}>{item.title}</Text>
                {userRole === 'admin' && (
                  <Button title="Delete" onPress={() => handleDeleteAnnouncement(item.id)} />
                )}
              </View>
            </TouchableOpacity>
          )}
        />
        {userRole === 'admin' && (
          <>
            <TextInput
              style={styles.input}
              placeholder="Enter new announcement content..."
              value={newTitle}
              onChangeText={setNewTitle}
            />
            <Button title="Publish Announcement" onPress={handleAddAnnouncement} />
          </>
          
        )}
      </View>
    );
  }

  if (loggedIn && selectedAnnouncementId !== null) {
    const currentAnnouncement = announcements.find(ann => ann.id === selectedAnnouncementId);
    return (
      <View style={styles.container}>
        <Text style={styles.heading}>Announcement Detail</Text>
        {currentAnnouncement && (
          <>
            <Text style={styles.itemText}>{currentAnnouncement.title}</Text>
            <Text style={styles.heading}>Comments</Text>
            <FlatList
              data={currentAnnouncement.comments}
              keyExtractor={item => item.id.toString()}
              renderItem={({ item }) => (
                <Text style={styles.itemText}>- {item.content}</Text>
              )}
            />
            <TextInput
              style={styles.input}
              placeholder="Enter your comment..."
              value={newComment}
              onChangeText={setNewComment}
            />
            <Button title="Submit Comment" onPress={handleAddComment} />
            <Button title="Back to List" onPress={() => setSelectedAnnouncementId(null)} />
          </>
        )}
        <Button title="Back" onPress={() => setContentPage(true)} />
      </View>
    );
  }

  return null;
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 20,
    justifyContent: 'center',
  },
  heading: {
    fontSize: 24,
    fontWeight: 'bold',
    marginBottom: 20,
    textAlign: 'center',
  },
  input: {
    height: 40,
    borderColor: 'gray',
    borderWidth: 1,
    marginBottom: 10,
    paddingHorizontal: 10,
  },
  itemContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#ccc',
  },
  itemText: {
    fontSize: 18,
  },
  centeredContent: {
  alignItems: 'center',
  justifyContent: 'center',
  flex: 1,
},
  squareBox: {
    width: 80,
    height: 80,
    backgroundColor: 'orange',
    borderRadius: 6,
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 10,
  },
  squareText: {
    textAlign: 'center',
    fontSize: 16,
    color: 'black',
    fontWeight: 'bold',
  },
  bottomButtons: {
    flex: 1,
    justifyContent: 'flex-end',
    marginBottom: 30,
  },
  buttonWrapper: {
    marginBottom: 15,
  },
});
